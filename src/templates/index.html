<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart City Rome Dashboard</title>
  <!-- scripts -->
  <script src="https://unpkg.com/maplibre-gl@^5.14.0/dist/maplibre-gl.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- styles -->
  <link href="https://unpkg.com/maplibre-gl@^5.14.0/dist/maplibre-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />
</head>

<body class="h-screen bg-gray-100">
  <!-- Main container -->
  <div class="relative h-full prevent-select" x-data="{ 
      selected: 'MAP', 
      mapCrossroad: null,
      isStatsView: false,
      stats: null,
      allCrossroads: [],
      init() {
          fetch('/api/crossroads')
              .then(res => res.json())
              .then(data => {
                  this.allCrossroads = data;
                  this.handleHashChange();
              })
              .catch(err => console.error(err));
          
          window.addEventListener('hashchange', () => this.handleHashChange());
      },
      handleHashChange() {
          const hash = window.location.hash;
          
          if (hash === '#map' || hash === '') {
              this.selected = 'MAP';
              this.isStatsView = false;
          } else if (hash === '#details') {
              this.selected = 'DETAILS';
              this.isStatsView = false;
          } else if (hash.startsWith('#details/')) {
              this.selected = 'DETAILS';
              this.isStatsView = true;
              const id = hash.split('/')[1];
              const c = this.allCrossroads.find(x => x.id === id);
              if (c) {
                  if (!this.mapCrossroad || this.mapCrossroad.id !== c.id) {
                      this.mapCrossroad = c;
                      this.fetchStats(c.id);
                  } else if (!this.stats) {
                      this.fetchStats(c.id);
                  }
              } else {
                 this.selected = 'DETAILS';
                 this.isStatsView = false;
              }
          } else if (hash === '#home') {
              this.selected = 'HOME';
          } else if (hash === '#cameras') {
              this.selected = 'CAMERAS';
          } else if (hash === '#issues') {
              this.selected = 'ISSUES';
          } else if (hash === '#areas') {
              this.selected = 'AREAS';
          }
      },
      fetchStats(id) {
          this.stats = null; 
          fetch(`/api/crossroads/${id}/stats`)
              .then(res => res.json())
              .then(data => { this.stats = data; })
              .catch(err => console.error(err));
      },
      selectCrossroad(c) {
          window.location.hash = `#details/${c.id}`;
      },
      clearMapSelection() {
          this.mapCrossroad = null;
          this.isStatsView = false; 
          window.dispatchEvent(new CustomEvent('map-selection-cleared'));
      }
  }" @crossroad-selected.window="mapCrossroad = $event.detail">
    <!-- Sidebar / Bottom Tab Bar -->
    <div
      class="fixed bottom-0 left-0 w-full h-16 md:absolute md:top-0 md:h-full md:w-44 z-50 flex flex-row md:flex-col bg-white border-t md:border-t-0 md:border-r md:shadow-xl overflow-hidden whitespace-nowrap">

      <div class="hidden md:flex items-center justify-center h-16 border-b border-gray-100 flex-shrink-0">
        <span class="text-lg font-bold tracking-tight text-gray-800">
          DASHBOARD
        </span>
      </div>

      <!-- Menu items -->
      <div
        class="flex-1 flex flex-row md:flex-col justify-around md:justify-start items-center md:items-stretch px-0 md:px-0 py-0 md:py-2 md:space-y-1 overflow-x-auto md:overflow-x-hidden overflow-y-hidden md:overflow-y-auto w-full">

        <a style="display: none;" href="#home" @click="selected = 'HOME'"
          class="group flex flex-col md:flex-row items-center justify-center md:justify-start px-2 md:px-4 py-1 md:py-2 text-xs md:text-sm font-medium transition-colors flex-1 md:flex-none md:h-10 relative"
          :class="selected === 'HOME' ? 'text-blue-600 md:bg-blue-50 md:text-blue-700 md:border-r-4 md:border-blue-600' : 'text-gray-500 hover:text-gray-900 md:text-gray-600 md:hover:bg-gray-50 md:border-r-4 md:border-transparent'">
          <div class="md:w-8 flex justify-center items-center flex-shrink-0 mr-0 md:mr-2">
            <ion-icon name="home-outline" class="text-2xl md:text-xl transition-transform duration-300"
              :class="selected === 'HOME' ? 'text-blue-600 scale-110' : 'text-gray-400 group-hover:text-gray-600'"></ion-icon>
          </div>
          <span class="md:hidden text-[10px]">HOME</span>
          <span class="hidden md:block">HOME</span>
        </a>

        <a href="#map" @click="selected = 'MAP'"
          class="group flex flex-col md:flex-row items-center justify-center md:justify-start px-2 md:px-4 py-1 md:py-2 text-xs md:text-sm font-medium transition-colors flex-1 md:flex-none md:h-10 relative"
          :class="selected === 'MAP' ? 'text-blue-600 md:bg-blue-50 md:text-blue-700 md:border-r-4 md:border-blue-600' : 'text-gray-500 hover:text-gray-900 md:text-gray-600 md:hover:bg-gray-50 md:border-r-4 md:border-transparent'">
          <div class="md:w-8 flex justify-center items-center flex-shrink-0 mr-0 md:mr-2">
            <ion-icon name="map-outline" class="text-2xl md:text-xl transition-transform duration-300"
              :class="selected === 'MAP' ? 'text-blue-600 scale-110' : 'text-gray-400 group-hover:text-gray-600'"></ion-icon>
          </div>
          <span class="md:hidden text-[10px]">MAP</span>
          <span class="hidden md:block">MAP</span>
        </a>

        <a href="#details" @click="selected = 'DETAILS'"
          class="group flex flex-col md:flex-row items-center justify-center md:justify-start px-2 md:px-4 py-1 md:py-2 text-xs md:text-sm font-medium transition-colors flex-1 md:flex-none md:h-10 relative"
          :class="selected === 'DETAILS' ? 'text-blue-600 md:bg-blue-50 md:text-blue-700 md:border-r-4 md:border-blue-600' : 'text-gray-500 hover:text-gray-900 md:text-gray-600 md:hover:bg-gray-50 md:border-r-4 md:border-transparent'">
          <div class="md:w-8 flex justify-center items-center flex-shrink-0 mr-0 md:mr-2">
            <ion-icon name="information-circle-outline" class="text-2xl md:text-xl transition-transform duration-300"
              :class="selected === 'DETAILS' ? 'text-blue-600 scale-110' : 'text-gray-400 group-hover:text-gray-600'"></ion-icon>
          </div>
          <span class="md:hidden text-[10px]">DETAILS</span>
          <span class="hidden md:block">DETAILS</span>
        </a>

        <a style="display: none;" href="#cameras" @click="selected = 'CAMERAS'"
          class="group flex flex-col md:flex-row items-center justify-center md:justify-start px-2 md:px-4 py-1 md:py-2 text-xs md:text-sm font-medium transition-colors flex-1 md:flex-none md:h-10 relative"
          :class="selected === 'CAMERAS' ? 'text-blue-600 md:bg-blue-50 md:text-blue-700 md:border-r-4 md:border-blue-600' : 'text-gray-500 hover:text-gray-900 md:text-gray-600 md:hover:bg-gray-50 md:border-r-4 md:border-transparent'">
          <div class="md:w-8 flex justify-center items-center flex-shrink-0 mr-0 md:mr-2">
            <ion-icon name="videocam-outline" class="text-2xl md:text-xl transition-transform duration-300"
              :class="selected === 'CAMERAS' ? 'text-blue-600 scale-110' : 'text-gray-400 group-hover:text-gray-600'"></ion-icon>
          </div>
          <span class="md:hidden text-[10px]">CAMS</span>
          <span class="hidden md:block">CAMERAS</span>
        </a>

        <a style="display: none;" href="#issues" @click="selected = 'ISSUES'"
          class="group flex flex-col md:flex-row items-center justify-center md:justify-start px-2 md:px-4 py-1 md:py-2 text-xs md:text-sm font-medium transition-colors flex-1 md:flex-none md:h-10 relative"
          :class="selected === 'ISSUES' ? 'text-blue-600 md:bg-blue-50 md:text-blue-700 md:border-r-4 md:border-blue-600' : 'text-gray-500 hover:text-gray-900 md:text-gray-600 md:hover:bg-gray-50 md:border-r-4 md:border-transparent'">
          <div class="md:w-8 flex justify-center items-center flex-shrink-0 mr-0 md:mr-2">
            <ion-icon name="alert-circle-outline" class="text-2xl md:text-xl transition-transform duration-300"
              :class="selected === 'ISSUES' ? 'text-blue-600 scale-110' : 'text-gray-400 group-hover:text-gray-600'"></ion-icon>
          </div>
          <span class="md:hidden text-[10px]">ISSUES</span>
          <span class="hidden md:block">ISSUES</span>
        </a>

        <a style="display: none;" href="#areas" @click="selected = 'AREAS'"
          class="group flex flex-col md:flex-row items-center justify-center md:justify-start px-2 md:px-4 py-1 md:py-2 text-xs md:text-sm font-medium transition-colors flex-1 md:flex-none md:h-10 relative"
          :class="selected === 'AREAS' ? 'text-blue-600 md:bg-blue-50 md:text-blue-700 md:border-r-4 md:border-blue-600' : 'text-gray-500 hover:text-gray-900 md:text-gray-600 md:hover:bg-gray-50 md:border-r-4 md:border-transparent'">
          <div class="md:w-8 flex justify-center items-center flex-shrink-0 mr-0 md:mr-2">
            <ion-icon name="location-outline" class="text-2xl md:text-xl transition-transform duration-300"
              :class="selected === 'AREAS' ? 'text-blue-600 scale-110' : 'text-gray-400 group-hover:text-gray-600'"></ion-icon>
          </div>
          <span class="md:hidden text-[10px]">AREAS</span>
          <span class="hidden md:block">AREAS</span>
        </a>
      </div>
    </div>

    <!-- Main Content -->
    <div class="w-full h-full bg-gray-200 relative pb-16 md:pb-0 md:pl-44 transition-all">
      <!-- Map section -->
      <div x-show="selected === 'MAP'" class="relative w-full h-full text-gray-700" id="map_wrapper">
        <div id="map" class="absolute inset-0 w-full h-full"></div>

        <!-- Map Overlay Controls -->
        <div id="map-controls"
          class="absolute top-4 left-4 flex flex-col space-y-2 z-50 overflow-hidden transition-all duration-300 transform scale-125 opacity-0 pointer-events-none"
          :class="mapCrossroad && selected === 'MAP' ? 'scale-100 opacity-100 pointer-events-auto' : ''">

          <!-- Exit Selection Button -->
          <button @click="clearMapSelection()"
            class="bg-white hover:bg-red-50 text-gray-600 hover:text-red-500 rounded-full p-2 shadow-lg transition-colors focus:outline-none w-10 h-10 flex items-center justify-center"
            title="Exit Selection">
            <ion-icon name="close-outline" class="text-xl"></ion-icon>
          </button>

          <!-- Info Button (Navigate to Details) -->
          <button @click="window.location.hash = `#details/${mapCrossroad.id}`"
            class="bg-white hover:bg-blue-50 text-gray-600 hover:text-blue-500 rounded-full p-2 shadow-lg transition-colors focus:outline-none w-10 h-10 flex items-center justify-center"
            title="View Details">
            <ion-icon name="information-circle-outline" class="text-xl"></ion-icon>
          </button>
        </div>
      </div>

      <!-- Details Section -->
      <div x-show="selected === 'DETAILS'"
        class="absolute inset-0 md:static p-8 w-full h-full overflow-y-auto bg-gray-200 z-40 md:z-auto">
        <!-- Detail View -->
        <template x-if="isStatsView && mapCrossroad">
          <div>
            <button @click="window.location.hash = '#details'"
              class="mb-4 text-blue-600 hover:text-blue-800 flex items-center">
              <ion-icon name="chevron-back-outline" class="text-xl mr-2"></ion-icon> Back to List
            </button>
            <h2 class="text-3xl font-bold mb-6 text-gray-800" x-text="mapCrossroad.name"></h2>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
              <!-- Cards ... bound to stats -->
              <template x-if="stats && stats.cards">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 col-span-full">
                  <template x-for="card in stats.cards" :key="card.title">
                    <div class="bg-white rounded-xl shadow-sm p-6 flex flex-col">
                      <span class="text-sm font-medium text-gray-500 uppercase tracking-wide"
                        x-text="card.title"></span>
                      <div class="mt-4 flex-1 flex items-end">
                        <span class="text-3xl font-bold text-gray-900" x-text="card.value"></span>
                      </div>
                    </div>
                  </template>
                </div>
              </template>

              <template x-if="stats && stats.error">
                <div class="col-span-full p-4 bg-red-100 text-red-700 rounded-lg">
                  Error loading stats: <span x-text="stats.error"></span>
                </div>
              </template>

              <template x-if="!stats">
                <div class="col-span-full flex justify-center p-8 animate-pulse">
                  <span class="text-gray-400">Loading stats...</span>
                </div>
              </template>
            </div>
          </div>
        </template>

        <!-- List View -->
        <template x-if="!isStatsView">
          <div>
            <h2 class="text-3xl font-bold mb-6 text-gray-800">Crossroads Directory</h2>
            <div class="grid gap-4">
              <template x-for="crossroad in allCrossroads" :key="crossroad.id">
                <div @click="selectCrossroad(crossroad)"
                  class="bg-white p-4 rounded-lg shadow-sm hover:shadow-md transition-shadow cursor-pointer flex justify-between items-center group">
                  <span class="font-medium text-lg text-gray-700 group-hover:text-blue-600 transition-colors"
                    x-text="crossroad.name"></span>
                  <ion-icon name="chevron-back-outline" class="text-gray-400 group-hover:text-blue-400"></ion-icon>
                </div>
              </template>
              <template x-if="allCrossroads.length === 0">
                <div class="text-gray-500">No crossroads available.</div>
              </template>
            </div>
          </div>
        </template>
      </div>

      <!-- Other sections placeholders -->
      <div x-show="selected !== 'MAP' && selected !== 'DETAILS'"
        class="flex items-center justify-center h-full text-gray-700">
        <span class="text-2xl font-semibold">SELECTED: <span x-text="selected"></span></span>
      </div>
    </div>
  </div>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
</body>

</html>